name: Luzhniki Monitor

on:
  schedule:
    - cron: "*/15 * * * *"  # –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install playwright proxy-chain node-fetch http-proxy-agent https-proxy-agent socks-proxy-agent
          npx playwright install chromium

      # üß† –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
      - name: Download previous state artifact (if any)
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow_conclusion: success
          name: luzhniki-state
          path: state
        continue-on-error: true

      - name: Run monitor script
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          PROXY_LIST: ${{ secrets.PROXY_LIST }}
        run: |
          node monitor-luzhniki.js

      # üì¶ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –¥–∏—Ñ—Ñ —Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
      - name: Upload state artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luzhniki-state
          path: state/snapshot.json
          if-no-files-found: ignore

      # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–ª–∏ html-–¥–∞–º–ø—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: luzhniki-debug
          path: |
            *.png
            *.html
